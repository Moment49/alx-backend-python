#!/bin/bash

# kubctl-0x01: Scale Django app and verify cluster

DEPLOYMENT_NAME="django-messaging-app"
NAMESPACE="default"  # Change if using a different namespace

# Step 1: Scale the deployment to 3 replicas
echo "ðŸš€ Scaling deployment '$DEPLOYMENT_NAME' to 3 replicas..."
kubectl scale deployment "$DEPLOYMENT_NAME" --replicas=3 -n $NAMESPACE

# Step 2: Wait a few seconds for pods to be created
sleep 5

# Step 3: Verify multiple pods are running
echo "ðŸ“¦ Checking pods..."
kubectl get pods -n $NAMESPACE

# Step 4: Perform load testing using wrk (assuming app is accessible via port-forward)
echo "âš¡ Starting port-forward for load testing..."
kubectl port-forward svc/django-messaging-service 8000:8000 -n $NAMESPACE &
PORT_FORWARD_PID=$!
sleep 3  # wait for port-forward to establish

echo "ðŸ”¹ Running load test with wrk..."
wrk -t2 -c10 -d10s http://127.0.0.1:8000/

# Stop port-forward
kill $PORT_FORWARD_PID

# Step 5: Monitor resource usage of pods
echo "ðŸ“Š Resource usage of pods:"
kubectl top pods -n $NAMESPACE

echo "âœ… Script completed."
